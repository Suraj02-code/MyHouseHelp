{% extends 'base.html' %}
{% load currency_filters %}

{% block title %}{{ service.title }} - Home Service Marketplace{% endblock %}

{% block content %}
<div class="container">
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
        <!-- Main Content -->
        <div>
            <div class="card">
                {% if service.service_image %}
                    <img src="{{ service.service_image.url }}" alt="{{ service.title }}" style="width: 100%; height: 300px; object-fit: cover; border-radius: 10px; margin-bottom: 20px;">
                {% endif %}
                
                <h1>{{ service.title }}</h1>
                <div style="display: flex; align-items: center; gap: 20px; margin: 15px 0; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                    <span class="badge badge-info">{{ service.category.name }}</span>
                    <div class="service-rating">
                        <span class="star">‚òÖ</span>
                        <span>{{ avg_rating }}/5</span>
                        <small>({{ total_reviews }} reviews)</small>
                    </div>
                </div>
                
                <div style="margin: 20px 0;">
                    <h3>Service Description</h3>
                    <p style="line-height: 1.6; color: #555;">{{ service.description|linebreaks }}</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 25px 0; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <div>
                        <strong>üí∞ Price:</strong> {{ service.base_price|inr }} {{ service.get_price_unit_display }}
                    </div>
                    <div>
                        <strong>‚è±Ô∏è Duration:</strong> {{ service.duration_hours }} hours
                    </div>
                    <div>
                        <strong>üìã Quote Required:</strong> {% if service.requires_quote %}Yes{% else %}No{% endif %}
                    </div>
                    <div>
                        <strong>‚úÖ Status:</strong> {% if service.is_active %}Active{% else %}Inactive{% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Provider Information -->
            <div class="card">
                <h3>üë§ Service Provider</h3>
                <div style="display: flex; align-items: center; gap: 15px; margin: 15px 0;">
                    {% if service.provider.profile_picture %}
                        <img src="{{ service.provider.profile_picture.url }}" alt="{{ service.provider.get_full_name }}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">
                    {% else %}
                        <div style="width: 60px; height: 60px; border-radius: 50%; background: #007bff; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                            {{ service.provider.first_name.0|default:service.provider.username.0 }}{{ service.provider.last_name.0 }}
                        </div>
                    {% endif %}
                    
                    <div>
                        <h4>{{ service.provider.get_full_name }}</h4>
                        {% if service.provider.provider_profile %}
                            <p style="color: #666; margin: 5px 0;">{{ service.provider.provider_profile.business_name }}</p>
                            <div style="font-size: 14px; color: #666;">
                                <span>‚≠ê {{ service.provider.provider_profile.average_rating|default:0 }}/5</span> ‚Ä¢
                                <span>üìã {{ service.provider.provider_profile.completed_jobs }} jobs completed</span> ‚Ä¢
                                <span>üìÖ {{ service.provider.provider_profile.years_of_experience }} years experience</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                {% if service.provider.provider_profile and service.provider.provider_profile.description %}
                    <p style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px;">{{ service.provider.provider_profile.description }}</p>
                {% endif %}
            </div>
            
            <!-- Availability -->
            {% if availability %}
            <div class="card">
                <h3>üïê Availability</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    {% for slot in availability %}
                    <div style="padding: 10px; background: #e8f5e8; border-radius: 5px; text-align: center;">
                        <strong>{{ slot.get_day_of_week_display }}</strong><br>
                        <small>{{ slot.start_time|time:"g:i A" }} - {{ slot.end_time|time:"g:i A" }}</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Reviews -->
            {% if reviews %}
            <div class="card">
                <h3>‚≠ê Customer Reviews</h3>
                {% for review in reviews %}
                <div style="border-bottom: 1px solid #eee; padding: 15px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div>
                            <strong>{{ review.customer.get_full_name }}</strong>
                            <div style="color: #ffc107;">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= review.overall_rating %}‚òÖ{% else %}‚òÜ{% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        <small style="color: #666;">{{ review.created_at|date:"M d, Y" }}</small>
                    </div>
                    <p>{{ review.comment }}</p>
                    {% if review.response %}
                        <div style="background: #f8f9fa; padding: 10px; border-left: 4px solid #007bff; margin-top: 10px;">
                            <strong>Provider Response:</strong>
                            <p style="margin: 5px 0 0;">{{ review.response.response_text }}</p>
                        </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        
        <!-- Sidebar -->
        <div>
            <!-- Book Service -->
            <div class="card">
                <h3>üìÖ Book This Service</h3>
                {% if user.is_authenticated %}
                    {% if user.role == 'customer' %}
                        {% if service.provider != user %}
                            <div style="text-align: center; padding: 20px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #28a745; margin-bottom: 10px;">{{ service.base_price|inr }}</div>
                                <p style="color: #666; margin-bottom: 20px;">{{ service.get_price_unit_display }}</p>
                                <a href="{% url 'bookings:book' service.id %}" class="btn btn-success" style="width: 100%; padding: 15px;">
                                    Book Now
                                </a>
                                {% if service.requires_quote %}
                                    <p style="font-size: 12px; color: #666; margin-top: 10px;">
                                        ‚ÑπÔ∏è This service requires a custom quote
                                    </p>
                                {% endif %}
                            </div>
                        {% else %}
                            <div style="text-align: center; padding: 20px; color: #666;">
                                <p>This is your own service</p>
                                <a href="{% url 'services:edit' service.id %}" class="btn btn-outline-primary">Edit Service</a>
                            </div>
                        {% endif %}
                    {% elif user.role == 'provider' %}
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <p>Switch to customer account to book services</p>
                        </div>
                    {% endif %}
                {% else %}
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 2rem; font-weight: bold; color: #28a745; margin-bottom: 10px;">{{ service.base_price|inr }}</div>
                        <p style="color: #666; margin-bottom: 20px;">{{ service.get_price_unit_display }}</p>
                        <a href="{% url 'accounts:login' %}?next={% url 'services:detail' service.id %}" class="btn btn-success" style="width: 100%; padding: 15px;">
                            Login to Book
                        </a>
                        <p style="font-size: 12px; margin-top: 10px;">
                            <a href="{% url 'accounts:register' %}?role=customer">Don't have an account? Sign up</a>
                        </p>
                    </div>
                {% endif %}
            </div>
            
            <!-- Contact Info -->
            <div class="card">
                <h3>üìû Contact Provider</h3>
                <div style="font-size: 14px; line-height: 1.6;">
                    {% if service.provider.phone_number %}
                        <p><strong>Phone:</strong> {{ service.provider.phone_number }}</p>
                    {% endif %}
                    <p><strong>Email:</strong> {{ service.provider.email }}</p>
                    {% if service.provider.address %}
                        <p><strong>Location:</strong> {{ service.provider.address }}</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Other Services -->
            {% if other_services %}
            <div class="card">
                <h3>üîß Other Services by {{ service.provider.get_full_name }}</h3>
                {% for other_service in other_services %}
                <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
                    <h5><a href="{% url 'services:detail' other_service.id %}" style="text-decoration: none;">{{ other_service.title }}</a></h5>
                    <div style="color: #28a745; font-weight: bold;">{{ other_service.base_price|inr }} {{ other_service.get_price_unit_display }}</div>
                    <small style="color: #666;">{{ other_service.category.name }}</small>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}